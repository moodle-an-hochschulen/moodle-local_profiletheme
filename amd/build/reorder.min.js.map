{"version":3,"sources":["../src/reorder.js"],"names":["define","$","SELECTORS","MOVETO","FIELDWRAPPER","RULENUMBER","showHideAndNextCheckbox","$andNextRule","closest","length","removeClass","last","addClass","removeCombinedDivs","$form","find","each","$this","unwrap","addCombinedDivs","$collection","$andnextrule","prop","add","wrapAll","updateCombinedDivs","checkReorderItems","e","$target","currentTarget","lastPosition","parseInt","data","newPosition","val","$displace","$moveSelects","attr","$moveItem","insertBefore","insertAfter","idx","position","html","showRulesToBeDeleted","$deleteRule","$container","init","on"],"mappings":"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","sourcesContent":["/**\n * Local plugin \"Profile field based theme delivery\" - JS code for reordering rules\n *\n * @module    local_profiletheme/reorder\n * @copyright 2016 Davo Smith, Synergy Learning UK on behalf of Alexander Bias, Ulm University <alexander.bias@uni-ulm.de>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/* Note: The @this comments throughout this file are just there to keep grunt satisfied */\n\ndefine(['jquery'], function($) {\n    \"use strict\";\n    var SELECTORS = {\n        MOVETO: 'select.moveto, .moveto select',\n        FIELDWRAPPER: '.localprofile-fieldwrapper',\n        RULENUMBER: '.localprofile-number'\n    };\n\n    /**\n     * The last rule should not show a 'and next rule' checkbox, but all the rest of the rules should.\n     */\n    function showHideAndNextCheckbox() {\n        var $andNextRule = $('#region-main form input.andnextrule');\n        if ($andNextRule.closest('label').length) {\n            // Boost theme wraps labels around input tags, instead of spans.\n            $andNextRule.closest('label').removeClass('hidden').last().addClass('hidden');\n        } else {\n            $andNextRule.closest('span').removeClass('hidden').last().addClass('hidden');\n        }\n    }\n\n    /**\n     * Remove all the divs that were wrapping rules that are combined together.\n     */\n    function removeCombinedDivs() {\n        var $form = $('#region-main form');\n        $form.find(SELECTORS.FIELDWRAPPER).removeClass('localprofile-flash').each(/* @this */function() {\n            var $this = $(this);\n            if ($this.closest('.localprofile-combined').length) {\n                $this.unwrap();\n            }\n        });\n    }\n\n    /**\n     * Find all rules that are combined together and wrap them in a div to visually indicate this.\n     */\n    function addCombinedDivs() {\n        var $collection = null;\n        var $form = $('#region-main form');\n        $form.find(SELECTORS.FIELDWRAPPER).each(/* @this */function() {\n            var $this = $(this);\n            var $andnextrule = $this.find('input.andnextrule');\n            if (!$andnextrule.length) {\n                return;\n            }\n            if ($andnextrule.prop('checked')) {\n                if ($collection) {\n                    $collection = $collection.add($this);\n                } else {\n                    $collection = $this;\n                }\n            } else {\n                if ($collection) {\n                    $collection = $collection.add($this);\n                    $collection.wrapAll('<div class=\"localprofile-combined\" />');\n                    $collection = null;\n                }\n            }\n        });\n        if ($collection) {\n            $collection.wrapAll('<div class=\"localprofile-combined\" />');\n            $collection = null;\n        }\n        showHideAndNextCheckbox();\n    }\n\n    /**\n     * Refresh the divs that show which rules are combined together.\n     */\n    function updateCombinedDivs() {\n        removeCombinedDivs();\n        addCombinedDivs();\n    }\n\n    /**\n     * Check if the item has been reordered and, if it has, insert it into the new position.\n     * @param {Object} e The event object.\n     */\n    function checkReorderItems(e) {\n        var $target = $(e.currentTarget);\n        var lastPosition = parseInt($target.data('lastPosition'), 10);\n        var newPosition = parseInt($target.val(), 10);\n        if (lastPosition === newPosition) {\n            return; // Nothing has changed.\n        }\n\n        // Find the item being displaced (i.e. the one that already has the 'position' we are moving to).\n        var $displace = null;\n        var $moveSelects = $(SELECTORS.MOVETO);\n        $moveSelects.each(/* @this */function() {\n            var $this = $(this);\n            if ($this.attr('id') !== $target.attr('id')) {\n                if (parseInt($this.val(), 10) === newPosition) {\n                    $displace = $this.closest(SELECTORS.FIELDWRAPPER);\n                    return false;\n                }\n            }\n            return true;\n        });\n        if (!$displace) {\n            return;\n        }\n\n        // Now we know we are moving elements, remove all 'combine with next rule' divs.\n        removeCombinedDivs();\n\n        // Put the moved item before, or after the 'displace' item, depending on whether we are moving up or down.\n        var $moveItem = $target.closest(SELECTORS.FIELDWRAPPER);\n        if (newPosition < lastPosition) {\n            $moveItem.insertBefore($displace);\n        } else {\n            $moveItem.insertAfter($displace);\n        }\n\n        // Update all the 'moveTo' selects.\n        $moveSelects = $(SELECTORS.MOVETO); // Reload the list of 'moveto' selects, in the new order.\n        $moveSelects.each(/* @this */function(idx) {\n            var $this = $(this);\n            var position = idx + 1;\n            $this.data('lastPosition', position);\n            $this.val(position);\n            $this.closest(SELECTORS.FIELDWRAPPER).find(SELECTORS.RULENUMBER).html(position);\n        });\n\n        // Flash the moved element.\n        $moveItem.removeClass('localprofile-flash').addClass('localprofile-flash');\n\n        // Replace the 'combine with next rule' divs.\n        addCombinedDivs();\n    }\n\n    /**\n     * Highlight each of the rules that will be deleted when the form is next saved.\n     */\n    function showRulesToBeDeleted() {\n        var $deleteRule = $('#region-main form input.deleterule');\n        $deleteRule.each(/* @this */function() {\n            var $this = $(this);\n            var $container = $this.closest('.localprofile-fieldwrapper');\n            if ($this.prop('checked')) {\n                $container.addClass('todelete');\n                $container.find(':input:not(.deleterule)').prop('disabled', true);\n            } else {\n                $container.removeClass('todelete');\n                $container.find(':input').prop('disabled', false);\n            }\n        });\n    }\n\n    return {\n        init: function() {\n            var $form = $('#region-main form');\n            $form.find(SELECTORS.MOVETO).each(/* @this */function() {\n                var $this = $(this);\n                $this.data('lastPosition', $this.val());\n            });\n            $form.on('change', SELECTORS.MOVETO, checkReorderItems);\n            $form.on('change', 'input.andnextrule', updateCombinedDivs);\n            $form.on('change', 'input.deleterule', showRulesToBeDeleted);\n            addCombinedDivs();\n        }\n    };\n});\n"],"file":"reorder.min.js"}